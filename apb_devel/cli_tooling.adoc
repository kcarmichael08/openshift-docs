[[apb-devel-cli]]
= CLI Tooling
{product-author}
{product-version]
:data-uri:
:icons:
:experimental:
:toc: macro
:toc-title:
:prewrap!:

toc::[]

[[apb-devel-cli-overview]]
== Overview

Use of the `apb` CLI tool to create Ansible Playbook Bundles (APB) is deprecated. Use the `ansible-galaxy` command that comes bundled with Ansible to create APBs. See link:https://galaxy.ansible.com/docs/contributing/creating_apb.html[Creating APBs] for more information.

Some commands for the `apb` CLI tool are still supported and are documented in the following sections.

[[apb-devel-cli-install]]
== Installing the Tool

[[apb-devel-cli-install-prereqs]]
=== Prerequisites

[[apb-devel-cli-install-prereqs-docker]]
==== Docker Daemon

The `docker` daemon must be correctly installed and running on the system.

[[apb-devel-cli-install-prereqs-access-permissions]]
==== Access Permissions

The `apb` tool requires you to be logged in as a tokened cluster user; the
default *system:admin* system user is not sufficient because it does not have a
token that can be used for the tool's authentication. In addition, there are a
number of local roles (project-scoped) and cluster roles (cluster-wide) that
must exist to permit the full breadth of the `apb` tool's functions (see
xref:../architecture/additional_concepts/authorization.adoc#cluster-and-local-rbac[Cluster and Local RBAC]).

The easiest option is to ensure the user has the *cluster-admin* cluster role.
To add this role to another user, you can run the following as a user that
already has such permissions (for example, the *system:admin* default system
user):

[WARNING]
====
This is effectively cluster *root* and should only be used in a development
setting.
====

----
$ oc adm policy add-cluster-role-to-user cluster-admin <user>
$ oc login -u <user> <openshift_server>
----

If you would like a more strictly permissioned environment, an OpenShift
template is provided that by default will permission a user called *developer*.
The template must be run by a user with sufficient permissions to create the
various roles. The *developer* user does not have such permissions, but the
*system:admin* user is sufficient.

To run the template:

. Download the
link:https://raw.githubusercontent.com/ansibleplaybookbundle/ansible-playbook-bundle/master/templates/openshift-permissions.template.yaml[*_openshift-permissions.template.yaml_*]
file locally.

. Run the following command:
+
----
$ oc process -f openshift-permissions.template.yaml \
  -p BROKER_NAMESPACE=openshift-ansible-service-broker \
  -p GLOBAL_IMAGE_PROJECT=default \
  [-p USER=<your_desired_user>] \ <1>
  | oc create -f -
----
<1> By default, the template will permission the *developer* user. You can
optionally use the `-p` flag to override this default value with your desired
user.

ifdef::openshift-origin[]
[[apb-devel-cli-install-containerized]]
=== Running From a Container

To run the `apb` tool from a container:

. Pull the container:
+
----
$ docker pull docker.io/ansibleplaybookbundle/apb-tools[:<tag>]
----
+
There are three tags to choose from:
+
--
- `latest`: more stable, less frequent releases.
- `nightly`: following upstream commits, installed from RPM.
- `canary`: following upstream commits, installed from source build.
--

. Choose one of the following:

.. Create an alias in your *_.bashrc_* or somewhere else for your shell:
+
----
alias apb='docker run --rm --privileged -v $PWD:/mnt -v $HOME/.kube:/.kube -v /var/run/docker.sock:/var/run/docker.sock -u $UID docker.io/ansibleplaybookbundle/apb-tools'
----

.. If you would prefer to use `atomic` rather than an alias:
+
----
$ atomic run docker.io/ansibleplaybookbundle/apb-tools init my_apb
----

. Start working by running the command:
+
----
$ ansible-galaxy init --type=apb my-new-apb
----
+
The first run may take awhile if you did not pull the image beforehand.
endif::[]

[[apb-devel-cli-install-rpm]]
=== Installing via RPM

ifdef::openshift-enterprise[]
The APB CLI tool is provided by the *apb* package, which is available from the
`rhel-7-server-ose-3.11-rpms` channel:

----
$ sudo yum install apb
----
endif::[]
ifdef::openshift-origin[]
For RHEL or CentOS 7:

----
$ su -c 'wget https://copr.fedorainfracloud.org/coprs/g/ansible-service-broker/ansible-service-broker-latest/repo/epel-7/group_ansible-service-broker-ansible-service-broker-latest-epel-7.repo -O /etc/yum.repos.d/ansible-service-broker.repo'

$ sudo yum -y install https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
$ sudo yum -y install apb
----

For Fedora 26 or Fedora 27:
----
$ sudo dnf -y install dnf-plugins-core
$ sudo dnf -y copr enable @ansible-service-broker/ansible-service-broker-latest
$ sudo dnf -y install apb
----
endif::[]

ifdef::openshift-origin[]
[[apb-devel-cli-install-source]]
=== Installing from Source

[[apb-devel-cli-install-source-python-virtualenv]]
==== Installing from Source: Python/VirtualEnv

. Clone the following repository:
+
----
$ git clone https://github.com/fusor/ansible-playbook-bundle.git
----

. Install *python-virtualenv*, create a virtualenv, and activate it:
+
----
$ sudo dnf install -y python-virtualenv
$ virtualenv /tmp/apb
$ source /tmp/apb/bin/activate
----

. Install requirements and run the setup script (requires `python`):
+
----
$ cd ansible-playbook-bundle && pip install -U setuptools && pip install -r src/requirements.txt && python setup.py install
----

. Optionally, if actively developing on the project, install the testing
requirements:
+
----
$ pip install -r src/test-requirements.txt
----

. If needed, reactivate the `apb` virtualenv in other shell sessions using:
+
----
$ source /tmp/apb/bin/activate
----

[[apb-devel-cli-install-source-tito]]
==== Installing from Source: Tito

Alternatively, you can use link:http://github.com/dgoodwin/tito[`tito`] to
install:

----
# tito build --test --rpm -i
----
endif::[]

[[apb-devel-cli-install-source-tito-verify]]
=== Verifying the Installation

Run `apb help` to make sure the tool is installed correctly:

----
$ apb help
Tool for working with Ansible Playbook Bundles

Usage:
  apb [command]

Available Commands:
  binding     Manage bindings
  broker      Interact with Automation Broker
  bundle      Interact with APBs
  catalog     Interact with OpenShift Service Catalog
  completion  Generates shell completion scripts
  config      Set tool defaults
  help        Help about any command
  registry    Configure registry adapters
  version     Get version

Flags:
      --config string       configuration directory (default is $HOME/.apb)
  -h, --help                help for apb
  -k, --kubeconfig string   Path to kubeconfig to use (default is $HOME/.kube/config)
  -v, --verbose             verbose output

Use "apb [command] --help" for more information about a command.
----

[[apb-devel-cli-workflows]]
== Typical Workflows

[[apb-devel-cli-workflows-local-registry]]
=== Local Registry

In order to use the OpenShift Container Registry to source APBs, you must have
configured the OpenShift Ansible broker to use the `local_openshift` type
registry adapter. See the
link:https://github.com/openshift/ansible-service-broker/blob/master/docs/config.md#local-openshift-registry[config]
section for more information.

----
$ ansible-galaxy init --type=apb my-new-apb
$ cd my-new-apb
$ oc new-build --binary=true --name my-new-apb
$ oc start-build --follow --from-dir . my-new-apb
$ apb bundle list
----

[[apb-devel-cli-workflows-remote-registry]]
=== Remote Registry

OpenShift Ansible Broker (OAB) can also be
link:https://github.com/openshift/ansible-service-broker/blob/master/docs/config.md#dockerhub-registry[configured]
to use a remote registry and organization such as
link:https://hub.docker.com/u/ansibleplaybookbundle/[*docker.io/ansibleplaybookbundle*]
or your own personal account. In order to use this for developing APBs, you can
build and push to your remote registry and then `bootstrap` to reload your APBs:

----
$ ansible-galaxy init --type=apb my-new-apb
$ cd my-new-apb
$ apb build --tag docker.io/my-org/my-new-apb
$ docker push docker.io/my-org/my-new-apb
$ apb broker bootstrap
$ apb bundle list
----

[[apb-devel-cli-creation-commands]]
== APB Creation Commands

[[apb-devel-cli-init]]
=== `ansible-galaxy init`

[discrete]
===== Description

Initializes a directory structure for a new APB. Also creates example files for
the new APB with sensible defaults.

[discrete]
===== Usage

----
$ ansible-galaxy init <role_name> [OPTIONS]
----

[discrete]
===== Arguments

`role_name`: Name of the APB role and directory to be created.

[discrete]
===== Options

[options="header"]
|===
| Option, Shorthand      | Description
| `--help,` `-h`             | Show help message
| `--server API_SERVER`, `--s API_SERVER` | The Galaxy API server URL
| `--api-key API_KEY` | The Ansible Galaxy API key available in your link:https://galaxy.ansible.com/me/preferences[Galaxy account preferences]. You can also set the token for the `GALAXY_SERVER_LIST` entry.
| `--ignore-certs`, `-c`  |  Ignore SSL certificate validation errors
| `--verbose`, `-v` |    Verbose mode. Use `-vvv` for more or `-vvvv` to enable connection debugging
| `--force`                | Force overwriting an existing role or collection
| `--offline`  | Don't query the galaxy API when creating roles
| `--init-path INIT_PATH` | The path in which the skeleton role will be created. The default is the current working directory.
| `--role-skeleton ROLE_SKELETON` | The path to a role skeleton that the new role should be based upon.
| `--type ROLE_TYPE` |       Initialize using an alternate role type. Valid types include: `container`, `apb`, and `network`.
|===

[discrete]
===== Examples

Create directory *_my-new-apb_*:

----
$ ansible-galaxy init my-new-apb
# ├── apb.yml
# ├── defaults
# │   └── main.yml
# ├── Dockerfile
# ├── files
# ├── handlers
# │   └── main.yml
# ├── Makefile
# ├── meta
# │   └── main.yml
# ├── playbooks
# │   ├── deprovision.yml
# │   └── provision.yml
# ├── README.md
# ├── tasks
# │   └── main.yml
# ├── templates
# ├── tests
# │   ├── ansible.cfg
# │   ├── inventory
# │   └── test.yml
# └── vars
#     └── main.yml
----

Create directory *_my-new-apb_*, overwriting any old versions.
----
$ ansible-galaxy init my-new-apb force
# my-new-apb/
# ├── apb.yml
# ├── defaults
# │   └── main.yml
# ├── Dockerfile
# ├── files
# ├── handlers
# │   └── main.yml
# ├── Makefile
# ├── meta
# │   └── main.yml
# ├── playbooks
# │   ├── deprovision.yml
# │   └── provision.yml
# ├── README.md
# ├── tasks
# │   └── main.yml
# ├── templates
# ├── tests
# │   ├── ansible.cfg
# │   ├── inventory
# │   └── test.yml
# └── vars
#     └── main.yml
----

[[apb-devel-cli-prepare]]
=== `apb bundle prepare`

[discrete]
===== Description

Compiles the APB into base64 encoding and writes it as a label to the *_Dockerfile_*.

This will allow the OAB to read the APB metadata from the registry without
downloading the images. This command must be run from inside the APB directory.

Running the `build` command will automatically run `prepare` as well, meaning you
generally do not need to run `prepare` by itself.

[discrete]
===== Usage

----
$ apb bundle prepare [OPTIONS]
----

[discrete]
===== Options

[options="header"]
|===
| Option, Shorthand  | Description
| `--help, -h`         | Show help message
| `--bundlemeta __<string>__, -b | APB metadata file to encode as base64. The default is `apb.yml`.
| `--containermeta __<string>__, -c | Container metadata file to stamp. The default is `Dockerfile`.
|  `--nolinebreak`, `-n` | Skip adding line breaks to base64 APB specification
|===

[discrete]
===== Examples

Prepare for APB image build by stamping *_apb.yml_* contents onto Dockerfile as base64:

----
$ apb bundle prepare --bundlemeta apb.yml
----

Stamps the Dockerfile container metadata file:

----
$ apb prepare --containermeta Dockerfile
----

[[apb-devel-cli-bundle-provision]]
=== `apb bundle provision`

[discrete]
===== Description

Provisions an APB from a registry adapter.

[discrete]
===== Usage

----
$ apb bundle provision <apb-name> [OPTIONS]
----

[discrete]
===== Options

[options="header"]
|===
| Option, Shorthand  | Description
| `--config string` | Configuration directory. The default is `$HOME/.apb`.
| `--follow`, `-f` | Print logs from provision pod
| `--help,` `-h`         | Show help message
| `--kubeconfig __<string>__`, `-k __<string>__` |  Path to kubeconfig to use. The default is `$HOME/.kube/config`.
| `--namespace __<string>__`, `-r` | Namespace to which to provision APB
| `--registry __<string>__`, `-s` | Registry from which to load APB
| `--sandbox-role __<string>__` | ClusterRole to be applied to the APB sandbox. The default is `edit`.
| `--verbose, -v`       |  Output verbose spec information from OAB
|===

[discrete]
===== Examples

Provision an APB:

----
$ apb provision my-new-apb
----

[[apb-devel-bundle-deprovision]]
=== `apb bundle deprovision`

[discrete]
===== Description

Deprovisions APB images.

[discrete]
===== Usage

----
$ apb bundle deprovision <bundle-name> [OPTIONS]
----

[discrete]
===== Options

[options="header"]
|===
| Option, Shorthand   | Description
| `--config string` | Configuration directory. The default is `$HOME/.apb`.
| `--follow`, `--f` | Print logs from deprovision pod
| `--help, -h`          | Show help message
| `--kubeconfig __<string>__`, `-k __<string>__` |  Path to kubeconfig to use. The default is `$HOME/.kube/config`.
| `--namespace __<string>__`, `-r` | Namespace from which to deprovision the APB
| `--sandbox-role __<string>__` | ClusterRole to be applied to the APB sandbox. The default is `edit`.
| `--skip-params` | Don't prompt for parameters
| `--verbose, -v`       |  Output verbose spec information from OAB
|===

[discrete]
===== Examples

----
$ apb bundle deprovision my-new-apb
----

[[apb-devel-cli-test]]
=== `apb bundle test`

[discrete]
===== Description

Tests an APB from a registry adapter.

[discrete]
===== Usage

----
$ apb bundle test <apb-name> [OPTIONS]
----

[discrete]
===== Options

[options="header"]
|===
| Option, Shorthand  | Description
| `--config string` | Configuration directory. The default is `$HOME/.apb`.
| `--follow`, `-f` | Print logs from provision pod
| `--help,` `-h`         | Show help message
| `--kubeconfig __<string>__`, `-k __<string>__` |  Path to kubeconfig to use. The default is `$HOME/.kube/config`.
| `--namespace __<string>__`, `-r` | Namespace to which to provision APB
| `--registry __<string>__`, `-s` | Registry from which to load APB
| `--sandbox-role __<string>__` | ClusterRole to be applied to the APB sandbox. The default is `edit`.
| `--verbose, -v`       |  Output verbose spec information from OAB
|===

[discrete]
===== Examples

Run the tests:

----
$ apb test my-new-apb
----

[[apb-devel-cli-list]]
=== `apb bundle list`

[discrete]
===== Description

Lists APBs from a registry adapter.

[discrete]
===== Usage

----
$ apb bundle list [OPTIONS]
----

[discrete]
===== Options

[options="header"]
|===
| Option, Shorthand  | Description
| `--config string` | Configuration directory. The default is `$HOME/.apb`.
| `--help,` `-h`         | Show help message
| `--kubeconfig __<string>__`, `-k __<string>__` |  Path to kubeconfig to use. The default is `$HOME/.kube/config`.
| `--refresh | Refresh list of specifications
| `--verbose, -v`       |  Output verbose spec information from OAB
|===

[discrete]
===== Examples

Basic list of APBs including name, ID, and description:

----
$ apb bundle list
----

List verbose, easily readable specs:

----
$ apb list -v
----

List all the JSON output:

----
$ apb list -v -o json
----

[[apb-devel-cli-build]]
=== `build (deprecated)`

[discrete]
===== Description

This command is deprecated. Use the `oc new-build` and `oc start-build` commands to build images for the APB. For more information, see link:https://docs.openshift.com/container-platform/3.11/dev_guide/builds/basic_build_operations.html[Basic Build Operations].

[[apb-devel-cli-push]]
=== `push (deprecated)`

[discrete]
===== Description

Uploads the APB to an OpenShift Container Registry or a broker mock
registry where it will be read by the OAB.

When using the broker's mock registry, the spec is uploaded and will be
displayed in {product-title}, but {product-title} will pull the image from the
registry normally. Usually that means the registry where `oc cluster up` was
performed.

When using the OpenShift Container Registry, the image is uploaded to
{product-title} directly.


[[apb-devel-cli-broker-utility-commands]]
== Broker Utility Commands

[[apb-devel-cli-broker-list]]
=== `apb broker catalog`

[discrete]
===== Description

Fetches a list of APBs in the Automation Broker catalog.

[discrete]
===== Usage

----
$ apb broker catalog [OPTIONS]
----

[discrete]
===== Options

[options="header"]
|===
| Option, Shorthand   | Description
| `--config string` | Configuration directory. The default is `$HOME/.apb`.
| `--help, -h`          | Show help message
| `--kubeconfig __<string>__`, `-k __<string>__` |  Path to kubeconfig to use. The default is `$HOME/.kube/config`.
| `--namespace __<string>__`, `-r` | Namespace of Automation Broker instance
| `--output __<string>__`, `-o __<string>__` | Display broker catalog output in different format. Use `json` or `yaml`.
| `--verbose, -v`       |  Output verbose spec information from OAB
|===

[discrete]
===== Examples

Fetch list of APBs in the Automation Broker catalog:

----
$ apb broker catalog
----

[[apb-devel-cli-bootstrap]]
=== `abp broker bootstrap`

[discrete]
===== Description

Refreshes the list of bootstrapped APBs in the Automation Broker catalog.

[discrete]
===== Usage

----
$ apb broker bootstrap [OPTIONS]
----

[discrete]
===== Options

[options="header"]
|===
| Option, Shorthand   | Description
| `--config string` | Configuration directory. The default is `$HOME/.apb`.
| `--help, -h`          | Show help message
| `--kubeconfig __<string>__`, `-k __<string>__` |  Path to kubeconfig to use. The default is `$HOME/.kube/config`.
| `--namespace __<string>__`, `-r` | Namespace of Automation Broker instance
| `--verbose, -v`       |  Output verbose spec information from OAB
|===

[discrete]
===== Examples

Basic refresh of APBs:

----
$ apb broker bootstrap
----


[[apb-devel-cli-other-commands]]
== Other Commands

[[apb-devel-cli-help]]
=== `help`

[discrete]
===== Description

Displays a help message.

[discrete]
===== Usage

----
$ apb help
----

[discrete]
===== Examples

----
$ apb help
----

----
$ apb -h
----

[[apb-devel-cli-info]]
=== `apb bundle info`

[discrete]
===== Description

Displays information about an APB.

[discrete]
===== Usage

----
$ apb bundle info <apb-name>
----

[discrete]
===== Options

[options="header"]
|===
| Option, Shorthand   | Description
| `--config string` | Configuration directory. The default is `$HOME/.apb`.
| `--help, -h`          | Show help message
| `--kubeconfig __<string>__`, `-k __<string>__` |  Path to kubeconfig to use. The default is `$HOME/.kube/config`.
| `--registry __<string>__`, `-r` | Registry from which to retrieve APB information
| `--verbose, -v`       |  Output verbose spec information from OAB
|===

[discrete]
===== Examples

----
$ apb bundle info my-new-apb
----
