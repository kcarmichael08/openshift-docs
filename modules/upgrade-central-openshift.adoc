// Module included in the following assemblies:
//
// * upgrade/upgrade-roxctl.adoc
:_module-type: PROCEDURE
[id="upgrade-central-openshift_{context}"]
= Upgrading Central on {ocp}

If you installed {product-title} on {ocp}, use the following procedure to upgrade.

.Procedure

. Patch the local role:
+
[source,terminal]
----
$ oc -n stackrox patch role edit -p '{"rules":[{"apiGroups":["*"],"resources":["*"],"verbs":["create","get", "list", "watch", "update", "patch", "delete","deletecollection"]}]}'
----
. Cleanup existing roles and role bindings:
+
[source,terminal]
----
$ oc -n stackrox delete RoleBinding admission-control-use-scc || true
----
+
[source,terminal]
----
$ oc -n stackrox delete RoleBinding sensor-use-scc || true
----
+
[source,terminal]
----
$ oc -n stackrox delete Role use-anyuid-scc || true
----
. Set `sensor` and `admission-control` to `restricted[-v2]` security context constraints by removing the hard-coded security context:
+
[source,terminal]
----
$ oc -n stackrox patch deploy sensor -p '{"spec":{"template":{"spec":{"securityContext":null}}}}' <1>
----
<1> {product-title} recreates the pods automatically, however, `sensor` can take some time to restart.
+
[source,terminal]
----
$ oc -n stackrox patch deploy admission-control -p '{"spec":{"template":{"spec":{"securityContext":null}}}}'
----
. Run the following commands to upgrade Central:
+
[source,terminal]
----
$ oc -n stackrox patch deploy/central -p '{"spec":{"template":{"spec":{"containers":[{"name":"central","env":[{"name":"ROX_NAMESPACE","valueFrom":{"fieldRef":{"fieldPath":"metadata.namespace"}}}]}]}}}}'
----
+
[source,terminal]
----
$ oc -n stackrox patch deployment/scanner -p '{"spec":{"template":{"spec":{"containers":[{"name":"scanner","securityContext":{"runAsUser":65534}}]}}}}'
----
+
[source,terminal,subs=attributes+]
----
$ oc -n stackrox set image deploy/central central=registry.redhat.io/advanced-cluster-security/rhacs-main-rhel8:{rhacs-version} <1>
----
<1> If you deploy images from a private image registry, push the new image into your private registry, and replace the image registry address here.
+
[IMPORTANT]
====
If you have not installed {product-title} by using Helm or Operator, and you want to enable authentication using the OpenShift OAuth server, you must run the following additional commands:
[source,terminal]
----
$ oc -n stackrox set env deploy/central ROX_ENABLE_OPENSHIFT_AUTH=true
----
[source,terminal]
----
$ oc -n stackrox patch serviceaccount/central -p '
{
"metadata": {
"annotations": {
"serviceaccounts.openshift.io/oauth-redirecturi.main": "sso/providers/openshift/callback",
"serviceaccounts.openshift.io/oauth-redirectreference.main": "{"kind":"OAuthRedirectReference","apiVersion":"v1","reference":{"kind":"Route","name":"central"}}"
}
}
}'
----
====

.Verification

* Verify that the new pods have deployed:
+
[source,terminal]
----
$ oc get deploy -n stackrox -o wide
----
+
[source,terminal]
----
$ oc get pod -n stackrox --watch
----
