:_content-type: ASSEMBLY
[id="upgrade-374"]
= Upgrading from release 3.74 to 4.x
include::modules/common-attributes.adoc[]
:context: upgrade-374

toc::[]

[role="_abstract"]
Upgrading from {product-title-short} 3.74 to 4.x requires some additional upgrade steps. You can upgrade by using the Operator (recommended) or by using Helm charts. Upgrading by using the `roxctl` CLI is not recommended.

The documentation provides detailed instructions for rolling back to the previous version if necessary. Before the upgrade, back up the existing Central database following the documented backup procedure so that you can roll back to the previous version if necessary. You are encouraged to practice rolling back to the previous version in the staging environment to ensure that your backup was successful and that rolling back the previous version brings the system back to the expected operational state.

[id="upgrade-overview"]
== Overview of upgrade procedure

To upgrade {product-title-short} to 4.0, perform the following steps:

. Upgrade to {product-title-short} version 3.74 if you have an earlier version installed by using one of these methods:
* xref:../upgrading/upgrade-374#upgrade-operator[Upgrade by using the Operator]
* xref:../upgrading/upgrade-374#upgrade-helm[Upgrade by using Helm charts]
* xref:../upgrading/upgrade-374#upgrade-roxctl[Upgrade by using the `roxctl` CLI]
. xref:../upgrading/upgrade-374#back-up-central-database_upgrade-374[Back up the database for Central].
. xref:../upgrading//upgrading/upgrade-374#upgrade-central-cluster[Upgrade Central to version 4.0].
. xref:../upgrading/upgrade-374#upgrade-secured-clusters[Upgrade secured clusters to version 4.0].

include::modules/back-up-central-database.adoc[leveloffset=+1]

//Upgrading RHACS
//operator upgrades
include::modules/upgrade-operator.adoc[leveloffset=+1]
//Helm upgrades
include::modules/upgrade-helm.adoc[leveloffset=+1]
include::modules/updating-helm-repository.adoc[leveloffset=+2]

.Additional resources

* xref:../installing/installing_ocp/install-central-ocp.adoc#install-using-helm-no-customizations-ocp[Installing Central using Helm charts]
* xref:../installing/installing_ocp/install-secured-cluster-ocp.adoc#installing-sc-helm[Installing {product-title-short} on secured clusters by using Helm charts]

//roxctl upgrades
include::modules/upgrade-roxctl.adoc[leveloffset=+1]

//upgrade central

[id="upgrade-central-cluster"]
== Upgrading the Central cluster

After you have backed up the Central database, the next step is to upgrade the Central cluster. This step includes upgrading Central, the `roxctl` CLI, and the Scanner.

[id="upgrade-central"]
=== Upgrading Central

You can update Central to the latest version by downloading and deploying the updated images.

include::modules/upgrade-central-openshift.adoc[leveloffset=+2]
include::modules/upgrade-central-kubernetes.adoc[leveloffset=+2]

//upgrade roxctl cli
[id="upgrade-roxctl-cli"]
== Upgrading the roxctl CLI

To upgrade the `roxctl` CLI to the latest version you must uninstall the existing version of `roxctl` CLI and then install the latest version of the `roxctl` CLI.

include::modules/uninstall-roxctl-cli.adoc[leveloffset=+2]
include::modules/install-roxctl-cli-linux.adoc[leveloffset=+2]
include::modules/install-roxctl-cli-macos.adoc[leveloffset=+2]
include::modules/install-roxctl-cli-windows.adoc[leveloffset=+2]

After you upgrade the `roxctl` CLI you can upgrade Scanner.

include::modules/upgrade-scanner.adoc[leveloffset=+2]
include::modules/upgrade-scanner-roxctl-371.adoc[leveloffset=+3]

include::modules/verify-central-cluster-upgrade.adoc[leveloffset=+2]

[id="upgrade-secured-clusters"]
== Upgrading all secured clusters

After upgrading Central services, you must upgrade all secured clusters.

[IMPORTANT]
====
* If you are using automatic upgrades:
** Update all your secured clusters by using automatic upgrades.
** Skip the instructions in this section and follow the instructions in the xref:../upgrading/upgrade-374.adoc#verify-upgrades_{context}[Verifying upgrades] and xref:../upgrading/upgrade-374.adoc#revoke-the-api-token_{context}[Revoking the API token] sections.
* If you are not using automatic upgrades, you must run the instructions in this section on all secured clusters including the Central cluster.
** To ensure optimal functionality, use the same {product-title-short} version for your secured clusters and the cluster on which Central is installed.
====

To complete manual upgrades of each secured cluster running Sensor, Collector, and Admission controller, follow the instructions in this section.

include::modules/update-validating-webhook-configuration.adoc[leveloffset=+2]

include::modules/update-other-images.adoc[leveloffset=+2]

include::modules/verify-secured-cluster-upgrade.adoc[leveloffset=+2]

include::modules/verify-upgrades.adoc[leveloffset=+1]

[id="rollback"]
== Rolling back an Operator upgrade

If you installed {product-title-short} using the Operator and selected *Automatic* in the *Update approval* field, {product-title-short} is automatically updated when a new software version is released. If you selected *Manual*, you must approve subsequent Operator updates by using Operator Lifecycle Manager (OLM). For more information, see link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.12/html/operators/administrator-tasks#olm-approving-pending-upgrade_olm-upgrading-operators[Manually approving a pending Operator update].

To roll back an Operator upgrade, you must perform the steps described in one of the following sections. You can roll back an Operator upgrade by using the CLI or the {ocp} web console.

include::modules/rollback-operator-upgrades-cli.adoc[leveloffset=+2]
include::modules/rollback-operator-upgrades-console.adoc[leveloffset=+2]

.Additional resources

* xref:../installing/installing_ocp/install-central-ocp.adoc#install-central-operator_install-central-ocp[Installing Central using the Operator method]
* link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.12/html/operators/understanding-operators#olm-workflow[Operator Lifecycle Manager workflow]
* link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.12/html/operators/administrator-tasks#olm-approving-pending-upgrade_olm-upgrading-operators[Manually approving a pending Operator update]

[id="rollback-central"]
== Rolling back Central

You can roll back to a previous version of Central if the upgrade to a new version is unsuccessful.

include::modules/rollback-central-normal.adoc[leveloffset=+2]

include::modules/rollback-central-forced.adoc[leveloffset=+2]

include::modules/revoke-the-api-token.adoc[leveloffset=+1]

include::modules/set-rox-scanner-init-db-env-variable.adoc[leveloffset=+2]

.Additional resources
* xref:../cli/getting-started-cli.adoc#cli-authentication_cli-getting-started[Authenticating using the `roxctl` CLI]